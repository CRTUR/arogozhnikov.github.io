---
layout: post
title: "Data manipulation with numpy: tips and tricks, part 1"
date: "2015-09-29"
author: Alex Rogozhnikov
tags:
- notebook
---


<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Data-manipulation-with-numpy:-tips-and-tricks,-part-1">Data manipulation with numpy: tips and tricks, part 1<a class="anchor-link" href="#Data-manipulation-with-numpy:-tips-and-tricks,-part-1">&#182;</a></h1><p>Some inobvious examples of what you can do with numpy are collected here.</p>
<p>Examples are mostly coming from area of machine learning, but will be useful if you're doing number crunching in python.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[1]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span> <span class="c"># for python 2 &amp; python 3 compaitibility</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="1.-numpy.argsort">1. numpy.argsort<a class="anchor-link" href="#1.-numpy.argsort">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Sorting-values-of-one-array-according-to-the-other">Sorting values of one array according to the other<a class="anchor-link" href="#Sorting-values-of-one-array-according-to-the-other">&#182;</a></h3><p>Say, we want to order the people according to their age and their heights.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[2]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">ages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">heights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">150</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">210</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">ages</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">heights</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[46 56 33 38 46 31 45 40 58 41]
[193 156 190 164 189 206 153 189 165 180]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[3]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">sorter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">ages</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ages</span><span class="p">[</span><span class="n">sorter</span><span class="p">])</span>
<span class="k">print</span><span class="p">(</span><span class="n">heights</span><span class="p">[</span><span class="n">sorter</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[31 33 38 40 41 45 46 46 56 58]
[206 190 164 189 180 153 193 189 156 165]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>once you computed permutation, you can apply it many times - this is fast.</p>
<p>Frequently to solve this problem people use sorted(zip(ages, heights)), which is much slower (10-20 times slower on large arrays).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Computing-inverse-of-permutation">Computing inverse of permutation<a class="anchor-link" href="#Computing-inverse-of-permutation">&#182;</a></h3><p>permutations in numpy are simply arrays:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[4]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">permutation</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">original</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="s">&#39;abcdefghij&#39;</span><span class="p">))</span>

<span class="k">print</span><span class="p">(</span><span class="n">permutation</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">original</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">original</span><span class="p">[</span><span class="n">permutation</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[9 6 1 0 7 8 5 2 4 3]
[&apos;a&apos; &apos;b&apos; &apos;c&apos; &apos;d&apos; &apos;e&apos; &apos;f&apos; &apos;g&apos; &apos;h&apos; &apos;i&apos; &apos;j&apos;]
[&apos;j&apos; &apos;g&apos; &apos;b&apos; &apos;a&apos; &apos;h&apos; &apos;i&apos; &apos;f&apos; &apos;c&apos; &apos;e&apos; &apos;d&apos;]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Inverse permutation</strong> is computed using numpy.argsort (again!)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[5]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">inverse_permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">permutation</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">original</span><span class="p">[</span><span class="n">permutation</span><span class="p">][</span><span class="n">inverse_permutation</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[&apos;a&apos; &apos;b&apos; &apos;c&apos; &apos;d&apos; &apos;e&apos; &apos;f&apos; &apos;g&apos; &apos;h&apos; &apos;i&apos; &apos;j&apos;]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>This is true because of two facts</strong>:</p>
<ol>
<li><p>indexing operation is associative (dramatically simple and interesting fact):</p>

<pre><code>a[b][c] = a[b[c]]</code></pre>
<p>provided that <code>a</code>, <code>b</code>, <code>c</code> are 1-dimensional arrays</p>
</li>
<li><p>`permutation[inverse_permutation] is identical permutation:</p>
</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[6]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">permutation</span><span class="p">[</span><span class="n">inverse_permutation</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[6]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([0, 1, 2, 3, 4, 5, 6, 7, 8, 9])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Computing-order-of-elements-in-array">Computing order of elements in array<a class="anchor-link" href="#Computing-order-of-elements-in-array">&#182;</a></h3><p>frequently it is important to compute order of each value in array.</p>
<p>In other words, for each element in array we want to find the number of elements smaller than given.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[7]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[ 0.43921505  0.60439554  0.10663623  0.72806766  0.7206455   0.11966843
  0.08749422  0.8063159   0.00212665  0.13166206]
[5 6 2 8 7 3 1 9 0 4]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>NB:</strong> there is scipy function which does the same, but it's more general and faster, so prefer using it:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[8]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">rankdata</span>
<span class="n">rankdata</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[8]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([ 5.,  6.,  2.,  8.,  7.,  3.,  1.,  9.,  0.,  4.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="IronTransform-(flattener-of-distribution)">IronTransform (flattener of distribution)<a class="anchor-link" href="#IronTransform-(flattener-of-distribution)">&#182;</a></h3><p>Sometimes you need to write monotonic tranformation, which turns one distribution into uniform.</p>
<p>This method is useful to compare distributions or to work with distributions with heavy tails or strange shape.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[9]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">class</span> <span class="nc">IronTransform</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">sorter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">sorter</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">sorter</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">interp</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's apply <strong>Iron</strong> transformation to data</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[10]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">sig_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="n">bck_pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[11]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sig_pred</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">bck_pred</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>


<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we can see that <strong>IronTransform</strong> actually was able to turn signal distribution to uniform:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[12]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">iron</span> <span class="o">=</span> <span class="n">IronTransform</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sig_pred</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sig_pred</span><span class="p">)))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">iron</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">sig_pred</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">iron</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">bck_pred</span><span class="p">),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>


<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="How-IronTransform-works">How IronTransform works<a class="anchor-link" href="#How-IronTransform-works">&#182;</a></h3><p>To turn any distribution into uniform, you should use mapping:
$x \to F(x)$, here $F(x)$ is cumulative distribution function.</p>
<p>In other words, for each point $x$ we should compute the part of distribution to the left. 
This was done by summing all weights to this point using <code>numpy.cumsum</code> (we also had to normalize weights).</p>
<p>To use the learned mapping, linear interpolation (<code>numpy.interp</code>) was applied.
We can visualize this mapping:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[13]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">iron</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">iron</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[13]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>[&lt;matplotlib.lines.Line2D at 0x10ae73290&gt;]</pre>
</div>

</div>

<div class="output_area"><div class="prompt"></div>


<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Also worth mentioning: to fight very small / large numbers, use <code>numpy.clip</code>. Simple and very handy:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[14]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">([</span><span class="o">-</span><span class="mi">100</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span> <span class="n">a_min</span><span class="o">=-</span><span class="mi">15</span><span class="p">,</span> <span class="n">a_max</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[14]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([-15, -10,   0,  10,  15])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[15]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[-5 -4 -3 -2 -1  0  1  2  3  4]
[0 0 0 0 0 0 1 2 3 4]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="2.-Broadcasting,-numpy.newaxis">2. Broadcasting, numpy.newaxis<a class="anchor-link" href="#2.-Broadcasting,-numpy.newaxis">&#182;</a></h1><p><a href="http://docs.scipy.org/doc/numpy/user/basics.broadcasting.html">Broadcasting</a> is very useful trick, which simplifies many operations.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Weighted-covariation-matrix">Weighted covariation matrix<a class="anchor-link" href="#Weighted-covariation-matrix">&#182;</a></h3><p>numpy has <code>cov</code> function, but it doesn't support weights of samples. Let's write our own covariation matrix.</p>
<p>Let $X_{ij}$ be the original data. $i$ is indexing samples, $j$ is indexing features.
$COV_{jk} = \sum_i X_{ij} w_i X_{ik}$</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[16]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">100</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[17]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">def</span> <span class="nf">covariation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[18]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[18]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([[ 0.88890211,  0.01909778, -0.09148101, -0.02988674, -0.03861163],
       [ 0.01909778,  1.13721745, -0.1723531 , -0.10818395,  0.07268447],
       [-0.09148101, -0.1723531 ,  1.1477238 ,  0.28418309, -0.06470338],
       [-0.02988674, -0.10818395,  0.28418309,  0.93714559,  0.01905542],
       [-0.03861163,  0.07268447, -0.06470338,  0.01905542,  0.78147565]])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[19]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">covariation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[19]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([[ 0.91323076,  0.03607582, -0.06028663, -0.02169456, -0.04973832],
       [ 0.03607582,  1.13471933, -0.15497915, -0.10302234,  0.06600708],
       [-0.06028663, -0.15497915,  1.16384791,  0.28853641, -0.07455084],
       [-0.02169456, -0.10302234,  0.28853641,  0.92964978,  0.01612915],
       [-0.04973832,  0.06600708, -0.07455084,  0.01612915,  0.77765108]])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[20]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">covariation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[20]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([[ 0.93191566,  0.02648263,  0.01068593,  0.0200474 , -0.09858467],
       [ 0.02648263,  1.19083162, -0.13379982, -0.12734206,  0.08361008],
       [ 0.01068593, -0.13379982,  1.24313924,  0.37213418, -0.03309349],
       [ 0.0200474 , -0.12734206,  0.37213418,  0.89748935,  0.10450732],
       [-0.09858467,  0.08361008, -0.03309349,  0.10450732,  0.73405636]])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>alternative way to do this is via <code>numpy.einsum</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[21]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s">&#39;ij, ik, i -&gt; jk&#39;</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">weights</span> <span class="o">/</span> <span class="n">weights</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[21]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([[ 0.93191566,  0.02648263,  0.01068593,  0.0200474 , -0.09858467],
       [ 0.02648263,  1.19083162, -0.13379982, -0.12734206,  0.08361008],
       [ 0.01068593, -0.13379982,  1.24313924,  0.37213418, -0.03309349],
       [ 0.0200474 , -0.12734206,  0.37213418,  0.89748935,  0.10450732],
       [-0.09858467,  0.08361008, -0.03309349,  0.10450732,  0.73405636]])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Pearson-correlation">Pearson correlation<a class="anchor-link" href="#Pearson-correlation">&#182;</a></h3><p>One more example of broadcasting: computation of Pearson coefficient.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[22]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[22]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([[ 1.        ,  0.01899477, -0.0905702 , -0.03274523, -0.04632692],
       [ 0.01899477,  1.        , -0.15086158, -0.10479427,  0.07710138],
       [-0.0905702 , -0.15086158,  1.        ,  0.27401605, -0.06832042],
       [-0.03274523, -0.10479427,  0.27401605,  1.        ,  0.02226677],
       [-0.04632692,  0.07710138, -0.06832042,  0.02226677,  1.        ]])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[23]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">def</span> <span class="nf">my_corrcoef</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="n">shifted_cov</span> <span class="o">=</span> <span class="n">covariation</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
    <span class="n">cov_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">shifted_cov</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shifted_cov</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov_diag</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> <span class="n">cov_diag</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:])</span>

<span class="n">my_corrcoef</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[23]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([[ 1.        ,  0.01899477, -0.0905702 , -0.03274523, -0.04632692],
       [ 0.01899477,  1.        , -0.15086158, -0.10479427,  0.07710138],
       [-0.0905702 , -0.15086158,  1.        ,  0.27401605, -0.06832042],
       [-0.03274523, -0.10479427,  0.27401605,  1.        ,  0.02226677],
       [-0.04632692,  0.07710138, -0.06832042,  0.02226677,  1.        ]])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Pairwise-distances-between-vectors">Pairwise distances between vectors<a class="anchor-link" href="#Pairwise-distances-between-vectors">&#182;</a></h3><p>we're given a set of vectors (say, 1000 vectors). The problem is to compute their pairwise distances.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[24]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">100</span><span class="p">])</span>
<span class="n">distances</span> <span class="o">=</span> <span class="p">((</span><span class="n">X</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">X</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>also, since algebra is you friend, you can do it times faster: 
$$||x_i - x_j||^2 = ||x_i||^2 + ||x_j||^2 - 2 (x_i, x_j) $$
so dot products is the only thing you need.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[25]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">products</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">distances2</span> <span class="o">=</span> <span class="n">products</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">+</span> <span class="n">products</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:]</span>  <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">products</span>
<span class="n">distances2</span> <span class="o">**=</span> <span class="mf">0.5</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>... but keep in mind there is <strong>sklearn.metrics.pairwise</strong> which does it for you and has different options</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[26]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">pairwise_distances</span>
<span class="n">distances_sklearn</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">distances_sklearn</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">distances2</span><span class="p">,</span> <span class="n">distances_sklearn</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[26]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>(True, True)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="3.-numpy.unique,-numpy.searchsorted">3. numpy.unique, numpy.searchsorted<a class="anchor-link" href="#3.-numpy.unique,-numpy.searchsorted">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Converting-categories-to-small-integers">Converting categories to small integers<a class="anchor-link" href="#Converting-categories-to-small-integers">&#182;</a></h3><p>Despite categories are easier to read, operating with them is much faster after you represent them as small numbers <br /> (for instance, in range [0, n_categories - 1])</p>
<p>First generate some categories:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[27]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="n">possible_categories</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="s">&#39;abcdefghijklmn&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">categories</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">possible_categories</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[&apos;dg&apos; &apos;ci&apos; &apos;dh&apos; ..., &apos;mn&apos; &apos;ln&apos; &apos;bd&apos;]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now we use <strong>numpy.unique</strong> to convert them to numbers (pay attention to <code>return_inverse=True</code>)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[28]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">unique_categories</span><span class="p">,</span> <span class="n">new_categories</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[29]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">print</span><span class="p">(</span><span class="n">unique_categories</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">new_categories</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[&apos;ab&apos; &apos;ac&apos; &apos;ad&apos; &apos;ae&apos; &apos;af&apos; &apos;ag&apos; &apos;ah&apos; &apos;ai&apos; &apos;aj&apos; &apos;ak&apos; &apos;al&apos; &apos;am&apos; &apos;an&apos; &apos;bc&apos; &apos;bd&apos;
 &apos;be&apos; &apos;bf&apos; &apos;bg&apos; &apos;bh&apos; &apos;bi&apos; &apos;bj&apos; &apos;bk&apos; &apos;bl&apos; &apos;bm&apos; &apos;bn&apos; &apos;cd&apos; &apos;ce&apos; &apos;cf&apos; &apos;cg&apos; &apos;ch&apos;
 &apos;ci&apos; &apos;cj&apos; &apos;ck&apos; &apos;cl&apos; &apos;cm&apos; &apos;cn&apos; &apos;de&apos; &apos;df&apos; &apos;dg&apos; &apos;dh&apos; &apos;di&apos; &apos;dj&apos; &apos;dk&apos; &apos;dl&apos; &apos;dm&apos;
 &apos;dn&apos; &apos;ef&apos; &apos;eg&apos; &apos;eh&apos; &apos;ei&apos; &apos;ej&apos; &apos;ek&apos; &apos;el&apos; &apos;em&apos; &apos;en&apos; &apos;fg&apos; &apos;fh&apos; &apos;fi&apos; &apos;fj&apos; &apos;fk&apos;
 &apos;fl&apos; &apos;fm&apos; &apos;fn&apos; &apos;gh&apos; &apos;gi&apos; &apos;gj&apos; &apos;gk&apos; &apos;gl&apos; &apos;gm&apos; &apos;gn&apos; &apos;hi&apos; &apos;hj&apos; &apos;hk&apos; &apos;hl&apos; &apos;hm&apos;
 &apos;hn&apos; &apos;ij&apos; &apos;ik&apos; &apos;il&apos; &apos;im&apos; &apos;in&apos; &apos;jk&apos; &apos;jl&apos; &apos;jm&apos; &apos;jn&apos; &apos;kl&apos; &apos;km&apos; &apos;kn&apos; &apos;lm&apos; &apos;ln&apos;
 &apos;mn&apos;]
[38 30 39 ..., 90 89 14]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Also we can reconstruct old categories if needed:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[30]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">print</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">unique_categories</span><span class="p">[</span><span class="n">new_categories</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[&apos;dg&apos; &apos;ci&apos; &apos;dh&apos; ..., &apos;mn&apos; &apos;ln&apos; &apos;bd&apos;]
[&apos;dg&apos; &apos;ci&apos; &apos;dh&apos; ..., &apos;mn&apos; &apos;ln&apos; &apos;bd&apos;]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Mapping-new-categories">Mapping new categories<a class="anchor-link" href="#Mapping-new-categories">&#182;</a></h3><p>When we need to map new categories using the same lookup table, we can use <code>numpy.searchsorted</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[31]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">categories2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">possible_categories</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">new_categories2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">unique_categories</span><span class="p">,</span> <span class="n">categories2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">categories2</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">unique_categories</span><span class="p">[</span><span class="n">new_categories2</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[&apos;ac&apos; &apos;aj&apos; &apos;fi&apos; ..., &apos;el&apos; &apos;hl&apos; &apos;ej&apos;]
[&apos;ac&apos; &apos;aj&apos; &apos;fi&apos; ..., &apos;el&apos; &apos;hl&apos; &apos;ej&apos;]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Checking-values-present-in-the-lookup">Checking values present in the lookup<a class="anchor-link" href="#Checking-values-present-in-the-lookup">&#182;</a></h3><p>Usually, we use <code>set</code> to have many checks that each element exists in array. But <strong>numpy.unique</strong> is better option - it works dozens times faster.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[32]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">([</span><span class="s">&#39;ab&#39;</span><span class="p">,</span> <span class="s">&#39;ac&#39;</span><span class="p">,</span> <span class="s">&#39;something new&#39;</span><span class="p">],</span> <span class="n">unique_categories</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[32]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([ True,  True, False], dtype=bool)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Handling-missing-categories">Handling missing categories<a class="anchor-link" href="#Handling-missing-categories">&#182;</a></h3><p>When some new category appears in test data, this is always a trouble. Possible solutions:</p>
<ul>
<li>map randomly to one of present categories (this, i.e. is done by hashing trick)</li>
<li>make a special category 'unknown' where all new values will be mapped. Then special value may be chosen for it.
This approach is more general, but requires more efforts.</li>
</ul>
<p>Below you can find the transformer for second approach:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[33]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">class</span> <span class="nc">CategoryMapper</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">categories</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
        
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">categories</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts categories to numbers, 0 is reserved for new values (not present in fitted data)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">,</span> <span class="n">categories</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">categories</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup</span><span class="p">)</span>    
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[34]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">CategoryMapper</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">categories</span><span class="p">)</span><span class="o">.</span><span class="n">transform</span><span class="p">([</span><span class="n">unique_categories</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;abc&#39;</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[34]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([1, 0])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="4.-numpy.percentile,-numpy.bincount">4. numpy.percentile, numpy.bincount<a class="anchor-link" href="#4.-numpy.percentile,-numpy.bincount">&#182;</a></h1>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Splitting-data-into-bins">Splitting data into bins<a class="anchor-link" href="#Splitting-data-into-bins">&#182;</a></h3><p>Splitting data into bins is frequently necessary. Simplest way done e.g. by <code>numpy.histogram</code> is splitting region with even bins of same size.</p>
<p>This usually works poorly with distributions with long tails (or strange shape) and requires additional transformation to avoid empty or too large bins.</p>
<p>However, for most cases creating the bins with equal number of events gives more convenient and stable results.
Selecting the edges of bins can be done with <code>numpy.percentile</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[35]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">20000</span><span class="p">)</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">40</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>


<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[36]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">edges</span><span class="p">,</span> <span class="n">normed</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>


<div class="output_png output_subarea ">
<img src="data:image/png;base64,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
SUVORK5CYII=
"
>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>the number of events within each bin is equal now.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Defining-the-index-of-bin">Defining the index of bin<a class="anchor-link" href="#Defining-the-index-of-bin">&#182;</a></h3><p>Use <code>numpy.searchsorted</code> to compute the index of bin for each value in <code>x</code>. (<code>numpy.digitize</code> is the other option, it does the same).</p>
<p><code>numpy.searchsorted</code> assumes that first array is sorted and uses binary search, so it is effective even for large amount of bins.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[37]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[37]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([10, 12, 14, ...,  7, 12, 11])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Counter">Counter<a class="anchor-link" href="#Counter">&#182;</a></h3><p>Need to know number of occurences for each category? Use <code>numpy.bincount</code> to compute the statistics:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[38]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">new_categories</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[38]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([38, 30, 39, ..., 90, 89, 14])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This will compute how many times each category present in the data:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[39]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">new_categories</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[39]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([ 91, 117, 109, 128, 106, 124, 103,  85, 116, 119, 116, 115, 113,
       102, 129, 128, 111, 107, 120, 110, 108, 115, 104, 120, 109, 120,
       104, 136, 133,  97,  87, 128, 105, 133,  98, 107, 120,  98,  91,
       109, 101,  98,  98, 118, 106, 107, 120, 104, 129, 105, 113, 137,
       110, 116,  93, 115, 121,  99, 111, 116, 105, 110, 120, 105, 107,
       123, 113, 103, 103, 131, 113,  84, 106, 104, 121,  96, 114, 115,
       103, 113, 108,  96, 100, 106,  87, 124,  90,  98, 100, 105, 109])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>the same done with <code>collections.Counter</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[40]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">Counter</span><span class="p">(</span><span class="n">new_categories</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()))[:,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[40]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([ 91, 117, 109, 128, 106, 124, 103,  85, 116, 119, 116, 115, 113,
       102, 129, 128, 111, 107, 120, 110, 108, 115, 104, 120, 109, 120,
       104, 136, 133,  97,  87, 128, 105, 133,  98, 107, 120,  98,  91,
       109, 101,  98,  98, 118, 106, 107, 120, 104, 129, 105, 113, 137,
       110, 116,  93, 115, 121,  99, 111, 116, 105, 110, 120, 105, 107,
       123, 113, 103, 103, 131, 113,  84, 106, 104, 121,  96, 114, 115,
       103, 113, 108,  96, 100, 106,  87, 124,  90,  98, 100, 105, 109])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Replace-category-with-number-of-occurences">Replace category with number of occurences<a class="anchor-link" href="#Replace-category-with-number-of-occurences">&#182;</a></h3><p>There are several tricks important to process the categorical features. 
Most known one is one-hot encoding, but let's speak about others.</p>
<p>One of tricks is to replace in each event category (which cannot be processed by most algorithms) with a number of times it presents in data.</p>
<p>This can be written in <strong>numpy</strong> one-liner:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[41]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">new_categories</span><span class="p">)[</span><span class="n">new_categories</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[41]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([ 91,  87, 109, ..., 109, 105, 129])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Averaging-predictions-over-category">Averaging predictions over category<a class="anchor-link" href="#Averaging-predictions-over-category">&#182;</a></h3><p>Another important trick: replace category with average prediction for events from this category.</p>
<p>This is more tricky, since we need to add weights to <code>numpy.bincount</code>:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[42]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">new_categories</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[43]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">means_over_category</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">new_categories</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">predictions</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">new_categories</span><span class="p">)</span>
<span class="n">means_over_category</span><span class="p">[</span><span class="n">new_categories</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[43]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([-0.00368337, -0.07046586,  0.13593826, ...,  0.13194701,
       -0.01045916, -0.03112919])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Variation-of-predictions-over-category">Variation of predictions over category<a class="anchor-link" href="#Variation-of-predictions-over-category">&#182;</a></h3><p>The same trick can be applied to measure deviation after invloving some math:
$$ \mathbb{V}x = \mathbb{E}x^2 - (\mathbb{E}x)^2 $$</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[44]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">means_of_squares_over_category</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">new_categories</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">predictions</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">new_categories</span><span class="p">)</span>
<span class="n">var_over_category</span> <span class="o">=</span> <span class="n">means_of_squares_over_category</span> <span class="o">-</span> <span class="n">means_over_category</span> <span class="o">**</span> <span class="mi">2</span>
<span class="n">var_over_category</span><span class="p">[</span><span class="n">new_categories</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[44]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([ 1.05129159,  0.99395241,  0.93697983, ...,  1.09291603,
        0.84810215,  1.34543933])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>You can also assign weights to events and compute weighted mean / weighted variation using the same functions.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Even-faster-inverse-permutation">Even faster inverse permutation<a class="anchor-link" href="#Even-faster-inverse-permutation">&#182;</a></h3><p>As was said, numpy.argsort returns inverse permutation, but it takes $O(n \log(n))$ time, while computing inverse permutation should take $O(n)$.</p>
<p>This optimal way (<code>inplace sort</code>) can be written in numpy.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[45]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">permutation</span><span class="p">))</span>
<span class="n">inverse_permutation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">permutation</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="n">inverse_permutation</span><span class="p">[</span><span class="n">permutation</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">permutation</span><span class="p">))</span>
<span class="k">print</span><span class="p">(</span><span class="n">inverse_permutation</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[3 2 7 9 8 6 1 4 5 0]
[3 2 7 9 8 6 1 4 5 0]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="5.-Numpy.ufunc.at">5. Numpy.ufunc.at<a class="anchor-link" href="#5.-Numpy.ufunc.at">&#182;</a></h2><p>To proceed futher, we need to know that there is class of binary (and unary) functions: <code>numpy.ufuncs</code></p>
<p>Examples: <code>numpy.add</code>, <code>numpy.subtract</code>, <code>numpy.multiply</code>, <code>numpy.maximum</code>, <code>numpy.minimum</code></p>
<p>In the following example we cook a new column with maximal predictions over category using <code>ufunc.at</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[46]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">max_over_category</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">new_categories</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">infty</span>
<span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">max_over_category</span><span class="p">,</span> <span class="n">new_categories</span><span class="p">,</span> <span class="n">predictions</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="n">max_over_category</span><span class="p">[</span><span class="n">new_categories</span><span class="p">])</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>[ 2.28802415  2.55736371  2.15283786 ...,  2.90273049  2.39761025
  3.53651835]
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Important note: <code>numpy.add.at</code> and <code>numpy.bincount</code> are very similar, but latter is dozens of times faster. Always prefer it to <code>numpy.add.at</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[47]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="o">%</span><span class="k">timeit</span> np.add.at(max_over_category, new_categories, predictions)
<span class="o">%</span><span class="k">timeit</span> np.bincount(new_categories, weights=predictions)
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>1000 loops, best of 3: 1.93 ms per loop
10000 loops, best of 3: 31.1 µs per loop
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Multidimensional-statistics:-numpy.add.at-and-smart-indexing">Multidimensional statistics: numpy.add.at and smart indexing<a class="anchor-link" href="#Multidimensional-statistics:-numpy.add.at-and-smart-indexing">&#182;</a></h3><p>When need to compute number of times each combination met, there are two ways:</p>
<ol>
<li>convert couple of variables to new variable, e.g. by feature1 * (numpy.max(feature2) + 1) + feature2</li>
<li>create multidimensional table</li>
</ol>
<p>I prefer first, code below is demonstration of second approach and it's benefits.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[48]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">first_category</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_categories</span><span class="p">))</span>
<span class="n">second_category</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_categories</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[49]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">counters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">first_category</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">second_category</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="o">.</span><span class="n">at</span><span class="p">(</span><span class="n">counters</span><span class="p">,</span> <span class="p">[</span><span class="n">first_category</span><span class="p">,</span> <span class="n">second_category</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now some useful things we can do with colected statistic. First thing is create feature, for which we use fancy indexing:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[50]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">counters</span><span class="p">[</span><span class="n">first_category</span><span class="p">,</span> <span class="n">second_category</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[50]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([ 2.,  1.,  3., ...,  1.,  1.,  2.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>We can also infer different statistics like:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[51]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="c"># occurences of second category</span>
<span class="n">counters</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">second_category</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[51]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([ 103.,   83.,   99., ...,   88.,   93.,   99.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[52]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="c"># maximal occurences of second category with same value of first category</span>
<span class="n">counters</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">second_category</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[52]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([ 4.,  3.,  5., ...,  5.,  4.,  5.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[53]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="c"># number of occurences of second category with fixed first category:</span>
<span class="n">counters</span><span class="p">[</span><span class="mi">42</span><span class="p">,</span> <span class="n">second_category</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[53]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>array([ 1.,  1.,  0., ...,  0.,  2.,  0.])</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>you are not limited to <code>numpy.add</code>, remember there are other ufuncs.</li>
<li>Few space to keep whole matrix? Use <code>scipy.sparse</code> if there are too many zero elements. 
Alternatively, you can use matrix decompositions to keep approximation of matrix and compute result on-the-fly.</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Computing-ROC-curve">Computing ROC curve<a class="anchor-link" href="#Computing-ROC-curve">&#182;</a></h3><p>As an important exercise, let's implement the computation of ROC curve. (interactive demo of ROC curve may be found <a href="https://arogozhnikov.github.io/2015/10/05/roc-curve.html">here</a> )</p>
<p>We will write the same as <code>sklearn.metrics.roc_curve</code> (actually, simplified version of it).</p>
<p>ROC curve takes three arrays: labels (binary, 0 or 1), predictions (real-valued) and weights.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[54]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">def</span> <span class="nf">roc_curve</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">sample_weight</span><span class="p">):</span>
    <span class="n">sig_weights</span> <span class="o">=</span> <span class="n">sample_weight</span> <span class="o">*</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">bck_weights</span> <span class="o">=</span> <span class="n">sample_weight</span> <span class="o">*</span> <span class="p">(</span><span class="n">labels</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">thresholds</span><span class="p">,</span> <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">return_inverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="n">tpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">sig_weights</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">fpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">bincount</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">bck_weights</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span>
    <span class="n">tpr</span> <span class="o">/=</span> <span class="n">tpr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fpr</span> <span class="o">/=</span> <span class="n">fpr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">thresholds</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[55]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">labels</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span>
<span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[56]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">fpr1</span><span class="p">,</span> <span class="n">tpr1</span><span class="p">,</span> <span class="n">thr1</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[57]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="c"># sometims sklearn adds one more element to all arrays.</span>
<span class="c"># I have no idea why this is needed and when, but in this case all answers turn to False</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_curve</span> <span class="k">as</span> <span class="n">sklearn_roc_curve</span>
<span class="n">fpr2</span><span class="p">,</span> <span class="n">tpr2</span><span class="p">,</span> <span class="n">thr2</span> <span class="o">=</span> <span class="n">sklearn_roc_curve</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">fpr1</span><span class="p">,</span> <span class="n">fpr2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">tpr1</span><span class="p">,</span> <span class="n">tpr2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">thr1</span><span class="p">,</span> <span class="n">thr2</span><span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt output_prompt">Out[57]:</div>


<div class="output_text output_subarea output_execute_result">
<pre>(True, True, True)</pre>
</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Weighted-Kolmogorov-Smirnov-distance">Weighted Kolmogorov-Smirnov distance<a class="anchor-link" href="#Weighted-Kolmogorov-Smirnov-distance">&#182;</a></h3><p>ROC curve is an important object by itself and freqently used in ML to compare distribution, 
but the magic is that it contains all order-based information about original distributions.</p>
<p>Next we compute KS distance based on ROC curve:</p>
$$ KS = \max_x \left| F_1(x) - F_2(x) \right| $$<p>(Order-based information == information, which is preserved under monotonic transformations)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[58]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="k">def</span> <span class="nf">ks_2samp</span><span class="p">(</span><span class="n">distribution1</span><span class="p">,</span> <span class="n">distribution2</span><span class="p">,</span> <span class="n">weights1</span><span class="p">,</span> <span class="n">weights2</span><span class="p">):</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">distribution1</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">distribution2</span><span class="p">))</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">distribution1</span><span class="p">,</span> <span class="n">distribution2</span><span class="p">])</span>
    <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">weights1</span><span class="p">,</span> <span class="n">weights2</span><span class="p">])</span>

    <span class="n">fpr</span><span class="p">,</span> <span class="n">tpr</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">roc_curve</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">sample_weight</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fpr</span> <span class="o">-</span> <span class="n">tpr</span><span class="p">))</span>
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[59]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="n">data1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
<span class="n">data2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
<span class="n">weights1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> 
<span class="n">weights2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span> 
</pre></div>

</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>Compare results</strong> with standard function:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[60]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython2"><pre><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">ks_2samp</span> <span class="k">as</span> <span class="n">ks_2samp_scipy</span>
<span class="k">print</span><span class="p">(</span> <span class="n">ks_2samp</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">weights1</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="p">),</span> <span class="n">weights2</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">size</span><span class="p">))</span> <span class="p">)</span>
<span class="k">print</span><span class="p">(</span> <span class="n">ks_2samp_scipy</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
</pre></div>

</div>
</div>
</div>

<div class="output_wrapper">
<div class="output">


<div class="output_area"><div class="prompt"></div>
<div class="output_subarea output_stream output_stdout output_text">
<pre>0.416
0.416
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Important moment that written function supports weights, while scipy version doesn't.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><strong>TODO:</strong> optimal F1, optimal accuracy based on ROC curve.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Conclusion">Conclusion<a class="anchor-link" href="#Conclusion">&#182;</a></h2><p>Many things can be written in numpy in efficient way, moreover resulting code will be short and (surpise!) more readable.</p>
<p>But this skill requires much practice.</p>
<h2 id="See-also">See also<a class="anchor-link" href="#See-also">&#182;</a></h2><ul>
<li>Second part of post: <a href="/2015/09/30/NumpyTipsAndTricks2.html">numpy tips and tricks 2</a></li>
<li><a href="/2015/09/08/SpeedBenchmarks.html">Numpy log-likelihood benchmark</a></li>
</ul>

</div>
</div>
</div>

<p>
    This post was written in IPython. You can download the notebook from
     <a href='https://github.com/arogozhnikov/arogozhnikov.github.io/tree/master/notebooks'>
    repository</a>.
</p>

